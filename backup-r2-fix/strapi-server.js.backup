'use strict';

const formatUrl = require('./services/format-url');

module.exports = (plugin) => {
  // Substituir a função findOne para formatar URLs
  const oldFindOne = plugin.services.upload.findOne;
  plugin.services.upload.findOne = async (id, populate) => {
    const file = await oldFindOne(id, populate);

    // Formatar URL se encontrou o arquivo
    if (file) {
      return formatUrl.formatFileUrl(file);
    }

    return file;
  };

  // Substituir a função findMany para formatar URLs
  const oldFindMany = plugin.services.upload.findMany;
  plugin.services.upload.findMany = async (query) => {
    const files = await oldFindMany(query);

    // Formatar URLs de todos os arquivos
    return files.map(file => formatUrl.formatFileUrl(file));
  };

  return plugin;
};
