'use strict';

const { formatR2Url } = require('../../../utils/r2');

/**
 * Substitui a URL padrão do R2 pelo domínio personalizado
 */
module.exports = {
  formatFileUrl(file, options = {}) {
    // Verificar se o arquivo tem URL
    if (!file?.url) {
      return file;
    }

    // Se o arquivo já estiver usando o domínio personalizado, apenas retorne
    if (process.env.R2_CUSTOM_DOMAIN && file.url.startsWith(process.env.R2_CUSTOM_DOMAIN)) {
      return file;
    }

    // Verificar se o arquivo é do R2 (verificando endpoint)
    if (process.env.R2_ENDPOINT && file.url.includes(process.env.R2_ENDPOINT)) {
      // Extrair o caminho relativo do arquivo
      const urlParts = file.url.split('/');
      // Pegar todos os segmentos após o nome do bucket
      const bucketPos = urlParts.indexOf(process.env.R2_BUCKET);

      if (bucketPos !== -1) {
        const relativePath = urlParts.slice(bucketPos + 1).join('/');
        // Formatar com a URL personalizada
        file.url = formatR2Url(relativePath);
      }
    }

    return file;
  },
};
